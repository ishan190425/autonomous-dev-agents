name: Publish to npm

on:
  push:
    tags:
      - 'v*' # Trigger on version tags (v1.0.0, v1.0.0-alpha.1, etc.)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip actual publish)'
        required: false
        default: 'false'
        type: boolean
      packages:
        description: 'Packages to publish (all, core, cli)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - core
          - cli

env:
  NODE_VERSION: '20.x'

jobs:
  # =============================================================================
  # Pre-publish quality gates â€” all checks must pass before any publishing
  # =============================================================================
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Lint all packages
        run: npm run lint --workspaces

      - name: ðŸ—ï¸ Build packages (ordered)
        run: |
          npm run build --workspace=packages/core
          npm run build --workspace=packages/cli
          npm run build --workspace=apps/web

      - name: ðŸ”Ž Type-check all packages
        run: npm run typecheck --workspaces

      - name: ðŸ§ª Test all packages
        run: npm run test --workspaces

      - name: ðŸ” Security audit
        run: npm audit --audit-level=moderate

      - name: âœ… Validate package manifests
        run: |
          echo "ðŸ” Validating package.json structure..."

          for pkg in packages/*/package.json; do
            pkg_name=$(jq -r '.name' "$pkg")
            echo "Checking $pkg_name..."
            
            # Required fields
            if ! jq -e '.name and .version and .description and .main and .types' "$pkg" > /dev/null; then
              echo "âŒ Missing required fields in $pkg"
              exit 1
            fi
            
            # publishConfig.access must be public for scoped packages
            access=$(jq -r '.publishConfig.access // "restricted"' "$pkg")
            if [[ "$access" != "public" ]]; then
              echo "âŒ publishConfig.access must be 'public' for $pkg_name"
              exit 1
            fi
            
            echo "  âœ… $pkg_name validated"
          done

  # =============================================================================
  # Publish @ada/core â€” must publish first (cli depends on it)
  # =============================================================================
  publish-core:
    name: Publish @ada/core
    runs-on: ubuntu-latest
    needs: quality-gates
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.packages == 'all' || github.event.inputs.packages == 'core'))

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build @ada/core
        run: npm run build --workspace=packages/core

      - name: ðŸ” Check if version exists on npm
        id: version-check
        run: |
          cd packages/core
          pkg_name=$(jq -r '.name' package.json)
          pkg_version=$(jq -r '.version' package.json)

          echo "Checking if $pkg_name@$pkg_version exists..."

          if npm view "$pkg_name@$pkg_version" version 2>/dev/null; then
            echo "âš ï¸  $pkg_name@$pkg_version already published â€” skipping"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… $pkg_name@$pkg_version not yet published"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“‹ Dry-run pack
        if: steps.version-check.outputs.exists == 'false'
        run: |
          cd packages/core
          echo "ðŸ“¦ Package contents:"
          npm pack --dry-run

      - name: ðŸš€ Publish @ada/core
        if: |
          steps.version-check.outputs.exists == 'false' &&
          (github.event_name == 'push' || github.event.inputs.dry_run != 'true')
        run: npm publish --workspace=packages/core --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ§ª Publish (dry-run mode)
        if: |
          steps.version-check.outputs.exists == 'false' &&
          github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ§ª DRY RUN â€” would publish @ada/core"
          npm publish --workspace=packages/core --access public --dry-run

  # =============================================================================
  # Publish @ada/cli â€” depends on @ada/core being published
  # =============================================================================
  publish-cli:
    name: Publish @ada/cli
    runs-on: ubuntu-latest
    needs: [quality-gates, publish-core]
    if: |
      always() &&
      needs.quality-gates.result == 'success' &&
      (needs.publish-core.result == 'success' || needs.publish-core.result == 'skipped') &&
      (github.event_name == 'push' ||
       (github.event_name == 'workflow_dispatch' && 
        (github.event.inputs.packages == 'all' || github.event.inputs.packages == 'cli')))

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build packages (ordered)
        run: |
          npm run build --workspace=packages/core
          npm run build --workspace=packages/cli

      - name: ðŸ” Check if version exists on npm
        id: version-check
        run: |
          cd packages/cli
          pkg_name=$(jq -r '.name' package.json)
          pkg_version=$(jq -r '.version' package.json)

          echo "Checking if $pkg_name@$pkg_version exists..."

          if npm view "$pkg_name@$pkg_version" version 2>/dev/null; then
            echo "âš ï¸  $pkg_name@$pkg_version already published â€” skipping"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… $pkg_name@$pkg_version not yet published"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“‹ Dry-run pack
        if: steps.version-check.outputs.exists == 'false'
        run: |
          cd packages/cli
          echo "ðŸ“¦ Package contents:"
          npm pack --dry-run

      - name: ðŸš€ Publish @ada/cli
        if: |
          steps.version-check.outputs.exists == 'false' &&
          (github.event_name == 'push' || github.event.inputs.dry_run != 'true')
        run: npm publish --workspace=packages/cli --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ§ª Publish (dry-run mode)
        if: |
          steps.version-check.outputs.exists == 'false' &&
          github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ§ª DRY RUN â€” would publish @ada/cli"
          npm publish --workspace=packages/cli --access public --dry-run

  # =============================================================================
  # Post-publish verification
  # =============================================================================
  verify-publish:
    name: Verify Publication
    runs-on: ubuntu-latest
    needs: [publish-core, publish-cli]
    if: |
      always() &&
      (needs.publish-core.result == 'success' || needs.publish-cli.result == 'success')

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: â³ Wait for npm registry propagation
        run: sleep 15

      - name: âœ… Verify @ada/core
        run: |
          core_version=$(jq -r '.version' packages/core/package.json)
          echo "Verifying @ada/core@$core_version..."

          if npm view "@ada/core@$core_version" version 2>/dev/null; then
            echo "âœ… @ada/core@$core_version verified on npm"
          else
            echo "âš ï¸  @ada/core@$core_version not found (may take time to propagate)"
          fi

      - name: âœ… Verify @ada/cli
        run: |
          cli_version=$(jq -r '.version' packages/cli/package.json)
          echo "Verifying @ada/cli@$cli_version..."

          if npm view "@ada/cli@$cli_version" version 2>/dev/null; then
            echo "âœ… @ada/cli@$cli_version verified on npm"
          else
            echo "âš ï¸  @ada/cli@$cli_version not found (may take time to propagate)"
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "## ðŸ“¦ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          core_version=$(jq -r '.version' packages/core/package.json)
          cli_version=$(jq -r '.version' packages/cli/package.json)

          echo "| Package | Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| @ada/core | $core_version | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "| @ada/cli | $cli_version | âœ… Published |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm install -g @ada/cli@$cli_version" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # Create GitHub Release â€” triggered only on tag push (not workflow_dispatch)
  # =============================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [verify-publish]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for changelog generation

      - name: ðŸ“‹ Extract version info
        id: version
        run: |
          # Extract version from tag (e.g., v1.0.0-alpha.1 â†’ 1.0.0-alpha.1)
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

          # Determine if prerelease (contains -, e.g., alpha, beta, rc)
          if [[ "$VERSION" == *"-"* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸  Detected prerelease version: $VERSION"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "ðŸ·ï¸  Detected stable version: $VERSION"
          fi

      - name: ðŸ“ Generate release notes
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Try to find the previous tag for comparison
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [[ -n "$PREV_TAG" ]]; then
            echo "ðŸ“š Generating changelog from $PREV_TAG to ${{ steps.version.outputs.tag }}..."
            RANGE="$PREV_TAG..HEAD"
          else
            echo "ðŸ“š Generating changelog for all commits (first release)..."
            RANGE="HEAD"
          fi

          # Generate categorized changelog
          {
            echo "## What's Changed"
            echo ""

            # Features
            FEATURES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^feat" 2>/dev/null || true)
            if [[ -n "$FEATURES" ]]; then
              echo "### âœ¨ Features"
              echo "$FEATURES"
              echo ""
            fi

            # Fixes
            FIXES=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^fix" 2>/dev/null || true)
            if [[ -n "$FIXES" ]]; then
              echo "### ðŸ› Bug Fixes"
              echo "$FIXES"
              echo ""
            fi

            # Docs
            DOCS=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^docs" 2>/dev/null || true)
            if [[ -n "$DOCS" ]]; then
              echo "### ðŸ“š Documentation"
              echo "$DOCS"
              echo ""
            fi

            # CI/Ops
            CI=$(git log $RANGE --pretty=format:"- %s (%h)" --grep="^ci\|^chore(ops)" 2>/dev/null || true)
            if [[ -n "$CI" ]]; then
              echo "### ðŸ”§ CI/CD & Infrastructure"
              echo "$CI"
              echo ""
            fi

            # Installation
            echo "## ðŸ“¦ Installation"
            echo ""
            echo '```bash'
            echo "npm install -g @ada/cli@$VERSION"
            echo '```'
            echo ""
            echo "Or install locally:"
            echo '```bash'
            echo "npm install @ada/cli@$VERSION"
            echo '```'
            echo ""

            # Links
            echo "## ðŸ”— Links"
            echo ""
            echo "- [npm: @ada/cli](https://www.npmjs.com/package/@ada/cli/v/$VERSION)"
            echo "- [npm: @ada/core](https://www.npmjs.com/package/@ada/core/v/$VERSION)"
            echo "- [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)"
          } > release_notes.md

          echo "ðŸ“ Release notes generated:"
          cat release_notes.md

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ADA ${{ steps.version.outputs.tag }}
          body_path: release_notes.md
          prerelease: ${{ steps.version.outputs.prerelease == 'true' }}
          generate_release_notes: false
          make_latest: ${{ steps.version.outputs.prerelease != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Release Summary
        run: |
          echo "## ðŸš€ GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ steps.version.outputs.prerelease == 'true' && 'Prerelease' || 'Stable' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY

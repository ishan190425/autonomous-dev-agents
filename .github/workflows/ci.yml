name: CI/CD Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  pr-enforcement:
    name: PR Enforcement (R-014)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Check for code changes requiring PR
        run: |
          echo "ðŸ›¡ï¸ PR Enforcement Check (R-014 Phase 3)"
          echo "========================================"
          echo ""

          # Get the commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "ðŸ“ Commit message: $COMMIT_MSG"
          echo ""

          # Check if this is a PR merge commit (squash merge from GitHub)
          # GitHub squash merges include the PR number in the commit message
          if echo "$COMMIT_MSG" | grep -qE '\(#[0-9]+\)$'; then
            echo "âœ… This is a PR merge commit â€” enforcement passed"
            exit 0
          fi

          # Check if this is an agent dispatch cycle (allowed for docs/state)
          if echo "$COMMIT_MSG" | grep -qE '^chore\(agents\): cycle [0-9]+'; then
            echo "ðŸ¤– Agent dispatch cycle detected â€” checking change types..."
          fi

          # Get changed files in this commit
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          echo "ðŸ“ Changed files:"
          echo "$CHANGED_FILES" | sed 's/^/   /'
          echo ""

          # Define code patterns that REQUIRE PRs
          CODE_PATTERNS="\.ts$|\.js$|\.tsx$|\.jsx$|\.py$"
          CONFIG_PATTERNS="package\.json$|tsconfig\.json$|\.eslintrc|vitest\.config"
          CI_PATTERNS="\.github/workflows/"

          # Check for code changes
          CODE_CHANGES=$(echo "$CHANGED_FILES" | grep -E "$CODE_PATTERNS" || true)
          CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E "$CONFIG_PATTERNS" || true)
          CI_CHANGES=$(echo "$CHANGED_FILES" | grep -E "$CI_PATTERNS" || true)

          # Combine all protected changes
          PROTECTED_CHANGES=""
          if [[ -n "$CODE_CHANGES" ]]; then
            PROTECTED_CHANGES="$CODE_CHANGES"
            echo "âš ï¸  Code changes detected:"
            echo "$CODE_CHANGES" | sed 's/^/   /'
          fi
          if [[ -n "$CONFIG_CHANGES" ]]; then
            PROTECTED_CHANGES="$PROTECTED_CHANGES$CONFIG_CHANGES"
            echo "âš ï¸  Config changes detected:"
            echo "$CONFIG_CHANGES" | sed 's/^/   /'
          fi
          if [[ -n "$CI_CHANGES" ]]; then
            PROTECTED_CHANGES="$PROTECTED_CHANGES$CI_CHANGES"
            echo "âš ï¸  CI/CD changes detected:"
            echo "$CI_CHANGES" | sed 's/^/   /'
          fi

          if [[ -n "$PROTECTED_CHANGES" ]]; then
            echo ""
            echo "âŒ ENFORCEMENT FAILED"
            echo "===================="
            echo "Direct pushes with code/config/CI changes are not allowed."
            echo "Per R-014 (Agent PR Workflow), these changes must go through a PR."
            echo ""
            echo "How to fix:"
            echo "  1. Revert this commit: git revert HEAD"
            echo "  2. Create a feature branch: git checkout -b ada/c{cycle}-{role}-{slug}"
            echo "  3. Cherry-pick your changes: git cherry-pick {commit}"
            echo "  4. Open a PR: gh pr create"
            echo ""
            echo "Or use: ada dispatch complete --action \"...\" --pr"
            echo ""
            echo "Allowed direct pushes:"
            echo "  - Documentation (.md files)"
            echo "  - Agent state (agents/ directory)"
            echo "  - PR merge commits"
            exit 1
          else
            echo "âœ… No protected changes â€” direct push allowed"
            echo "   (Only docs/agent state changes detected)"
          fi

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Lint all packages
        run: npm run lint --workspaces

      - name: ðŸ—ï¸ Build packages (ordered â€” core before cli for project references)
        run: |
          npm run build --workspace=packages/core
          npm run build --workspace=packages/cli
          npm run build --workspace=apps/web

      - name: ðŸ”Ž Type-check all packages
        run: npm run typecheck --workspaces

      - name: ðŸ§ª Test all packages
        run: npm run test --workspaces

      - name: ðŸ” Security audit
        run: npm audit --audit-level=moderate

  package-validation:
    name: Package Validation
    runs-on: ubuntu-latest
    needs: quality-gates

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build packages
        run: |
          npm run build --workspace=packages/core
          npm run build --workspace=packages/cli
          npm run build --workspace=apps/web

      - name: âœ… Validate package.json files
        run: |
          echo "ðŸ” Validating package.json structure..."

          # Check that all packages have required fields
          for pkg in packages/*/package.json; do
            echo "Checking $pkg..."
            
            # Extract package name for logging
            pkg_name=$(jq -r '.name' "$pkg")
            echo "  Package: $pkg_name"
            
            # Required fields check
            if ! jq -e '.name and .version and .description and .main and .types' "$pkg" > /dev/null; then
              echo "âŒ Missing required fields in $pkg"
              exit 1
            fi
            
            # TypeScript strict mode check
            tsconfig_path=$(dirname "$pkg")/tsconfig.json
            if [[ -f "$tsconfig_path" ]]; then
              if ! jq -e '.compilerOptions.strict == true' "$tsconfig_path" > /dev/null; then
                echo "âŒ TypeScript strict mode not enabled in $tsconfig_path"
                exit 1
              fi
            fi
            
            echo "  âœ… $pkg_name validation passed"
          done

          echo "ðŸŽ‰ All packages validated successfully"

      - name: ðŸ“Š Package dependency check
        run: |
          echo "ðŸ” Checking workspace dependencies..."

          # Check for proper workspace protocol usage
          for pkg in packages/*/package.json; do
            pkg_name=$(jq -r '.name' "$pkg")
            
            # Check if any workspace packages use workspace protocol
            workspace_deps=$(jq -r '.dependencies // {} | to_entries[] | select(.key | startswith("@ada-ai/")) | .value' "$pkg" 2>/dev/null || true)
            
            if [[ -n "$workspace_deps" ]]; then
              echo "  $pkg_name uses workspace dependencies:"
              echo "$workspace_deps" | while read -r dep; do
                if [[ "$dep" != "workspace:*" ]]; then
                  echo "    âš ï¸  Should use 'workspace:*' protocol: $dep"
                else
                  echo "    âœ… $dep"
                fi
              done
            fi
          done

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: quality-gates

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ“ Code metrics
        run: |
          echo "ðŸ“Š Code Quality Metrics"
          echo "======================"

          # Count lines of TypeScript code
          echo "ðŸ“ TypeScript files:"
          find packages -name "*.ts" -not -path "*/node_modules/*" -not -path "*/dist/*" | wc -l

          echo "ðŸ“„ Total TypeScript lines:"
          find packages -name "*.ts" -not -path "*/node_modules/*" -not -path "*/dist/*" -exec wc -l {} + | tail -1

          # Check for any usage that should be flagged
          echo "ðŸš¨ Code quality checks:"

          # Check for console.log in library code (should only be in CLI)
          console_count=$(find packages -name "*.ts" -not -path "*/cli/*" -not -path "*/node_modules/*" -not -path "*/dist/*" -exec grep -l "console\.log" {} + | wc -l || true)

          if [[ "$console_count" -gt 0 ]]; then
            echo "  âš ï¸  Found console.log in library code (should only be in CLI)"
            find packages -name "*.ts" -not -path "*/cli/*" -not -path "*/node_modules/*" -not -path "*/dist/*" -exec grep -l "console\.log" {} +
          else
            echo "  âœ… No console.log in library code"
          fi

          # Check for any types usage
          any_count=$(find packages -name "*.ts" -not -path "*/node_modules/*" -not -path "*/dist/*" -exec grep -c ": any" {} + | paste -sd+ | bc || true)
          echo "  ðŸ“Š 'any' type usage count: $any_count"

  rules-compliance:
    name: Rules Compliance Check
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“‹ Validate commit message (if PR)
        if: github.event_name == 'pull_request'
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "ðŸ” Checking commit message compliance..."
          echo "PR Title: $PR_TITLE"

          # Check conventional commit format: type(scope): description
          # Note: Using env var to avoid shell expansion issues with backticks in PR titles
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+'; then
            echo "âŒ PR title must follow conventional commit format"
            echo "   Format: type(scope): description"
            echo "   Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
            echo "   Example: feat(cli): add ada init command"
            exit 1
          else
            echo "âœ… PR title follows conventional commit format"
          fi

      - name: ðŸ” Check TypeScript strict compliance
        run: |
          echo "ðŸ”Ž Validating TypeScript strict mode compliance..."

          # Check all tsconfig.json files have strict mode enabled
          find . -name "tsconfig.json" -not -path "*/node_modules/*" | while read -r tsconfig; do
            echo "Checking $tsconfig..."
            
            if ! grep -q '"strict": true' "$tsconfig"; then
              echo "âŒ TypeScript strict mode not enabled in $tsconfig"
              exit 1
            fi
          done

          echo "âœ… All tsconfig.json files have strict mode enabled"

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: quality-gates

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build packages
        run: |
          npm run build --workspace=packages/core
          npm run build --workspace=packages/cli
          npm run build --workspace=apps/web

      - name: ðŸ“Š Generate coverage report (core)
        run: |
          echo "ðŸ“Š Running @ada-ai/core test coverage..."
          cd packages/core
          npm run test:coverage -- --reporter=default --reporter=json
          echo ""
          echo "ðŸ“ˆ Coverage Summary:"
          echo "===================="
          cat coverage/coverage-summary.json | jq -r '
            .total | 
            "Statements: \(.statements.pct)% (\(.statements.covered)/\(.statements.total))\n" +
            "Branches:   \(.branches.pct)% (\(.branches.covered)/\(.branches.total))\n" +
            "Functions:  \(.functions.pct)% (\(.functions.covered)/\(.functions.total))\n" +
            "Lines:      \(.lines.pct)% (\(.lines.covered)/\(.lines.total))"
          '

      - name: ðŸ“Š CLI test metrics
        run: |
          echo ""
          echo "ðŸ“Š @ada-ai/cli Test Metrics"
          echo "========================"
          echo "â„¹ï¸  Note: CLI uses subprocess testing (child processes for each command)."
          echo "    v8 coverage can't capture subprocess execution, but tests are comprehensive."
          echo ""
          cd packages/cli
          npm test -- --reporter=verbose 2>&1 | tail -20
          echo ""
          TEST_COUNT=$(npm test -- --reporter=json 2>&1 | jq -r '.numTotalTests // 0' 2>/dev/null || echo "N/A")
          echo "Total CLI tests: See test output above"

      - name: ðŸŽ¯ Coverage thresholds check (core)
        run: |
          echo "ðŸŽ¯ Validating coverage thresholds..."
          cd packages/core
          npm run test:coverage 2>&1 | grep -E "(ERROR|Coverage|âœ“)" || true

          # Check if coverage meets thresholds (defined in vitest.config.ts)
          # Thresholds: statements: 80%, branches: 75%, functions: 80%, lines: 80%
          COVERAGE_JSON="coverage/coverage-summary.json"
          if [[ -f "$COVERAGE_JSON" ]]; then
            STATEMENTS=$(cat "$COVERAGE_JSON" | jq -r '.total.statements.pct')
            BRANCHES=$(cat "$COVERAGE_JSON" | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat "$COVERAGE_JSON" | jq -r '.total.functions.pct')
            LINES=$(cat "$COVERAGE_JSON" | jq -r '.total.lines.pct')
            
            echo ""
            echo "Coverage vs Thresholds:"
            echo "  Statements: ${STATEMENTS}% (threshold: 80%)"
            echo "  Branches:   ${BRANCHES}% (threshold: 75%)"
            echo "  Functions:  ${FUNCTIONS}% (threshold: 80%)"
            echo "  Lines:      ${LINES}% (threshold: 80%)"
            
            # Vitest enforces thresholds, but we provide clear feedback here
            if (( $(echo "$STATEMENTS < 80" | bc -l) )) || \
               (( $(echo "$BRANCHES < 75" | bc -l) )) || \
               (( $(echo "$FUNCTIONS < 80" | bc -l) )) || \
               (( $(echo "$LINES < 80" | bc -l) )); then
              echo ""
              echo "âš ï¸  Coverage below thresholds. See vitest output for details."
            else
              echo ""
              echo "âœ… All coverage thresholds met!"
            fi
          fi

  publish-preview:
    name: Publish Preview (Dry Run)
    runs-on: ubuntu-latest
    needs: [quality-gates, package-validation]
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build packages
        run: |
          npm run build --workspace=packages/core
          npm run build --workspace=packages/cli
          npm run build --workspace=apps/web

      - name: ðŸ“‹ Dry-run publish
        run: |
          echo "ðŸ§ª Testing package publishing (dry-run)..."

          # Test npm pack for each package
          for pkg_dir in packages/*/; do
            if [[ -f "$pkg_dir/package.json" ]]; then
              echo "Testing package in $pkg_dir..."
              cd "$pkg_dir"
              npm pack --dry-run
              cd - > /dev/null
              echo "âœ… Package validation passed"
            fi
          done

# PR Workflow Specification

> **Issue:** #128 â€” Agents should open PRs instead of direct commits to main
> **Status:** Specification (Sprint 2 Implementation)
> **Author:** ðŸ›¡ï¸ Ops (C364)
> **Created:** 2026-02-10

---

## Executive Summary

ADA agents currently commit directly to `main`, bypassing code review gates and CI-before-merge checks. This specification defines a PR-based workflow for agent code changes, improving code quality, safety, and auditability while maintaining dispatch velocity for documentation-only changes.

---

## Current State

```
Agent â†’ Make changes â†’ Commit to main â†’ Push â†’ CI runs (after merge)
```

**Problems:**

1. No code review gate â€” risky changes bypass human oversight
2. No CI check before merge â€” tests run after code is in main
3. Hard to revert â€” individual features not isolated
4. Against best practices â€” direct-to-main is an anti-pattern

---

## Proposed Workflow

### Change Classification

| Change Type                                           | Workflow    | Rationale                      |
| ----------------------------------------------------- | ----------- | ------------------------------ |
| **Code** (`.ts`, `.js`, `.json` with logic)           | PR Required | High risk, needs CI gate       |
| **Tests** (`.test.ts`, `.spec.ts`)                    | PR Required | Code changes, needs validation |
| **Config** (`tsconfig.json`, `eslint.config.js`)      | PR Required | Can break builds               |
| **Docs** (`.md`, non-logic JSON)                      | Direct OK   | Low risk, high velocity        |
| **Agent state** (`agents/memory/*`, `agents/state/*`) | Direct OK   | Operational, not code          |

### PR Workflow for Code Changes

```
1. Start dispatch cycle (ada dispatch start)
2. Make code changes
3. Create branch: ada/c{cycle}-{role}-{slug}
4. Commit to branch
5. Open PR with structured description
6. Wait for CI (auto-triggered)
7. If CI passes â†’ Self-merge (squash)
8. If CI fails â†’ Fix and retry
9. Complete dispatch (ada dispatch complete)
```

### Branch Naming Convention

```
ada/c{cycle}-{role}-{action-slug}

Examples:
- ada/c364-ops-pr-workflow
- ada/c365-engineering-terminal-mode
- ada/c366-qa-e2e-fixes
```

**Rules:**

- Max 50 chars total
- Lowercase, hyphen-separated
- No special characters
- Cycle number provides ordering and uniqueness

### PR Template (Agent-Generated)

```markdown
## ðŸ¤– Agent PR â€” Cycle {N}

**Role:** {emoji} {role_name}
**Action:** {action_description}

### Changes

{bullet_list_of_changes}

### Testing

- [ ] Local tests pass (`npm test --workspaces`)
- [ ] Type check passes (`npm run typecheck --workspaces`)
- [ ] Lint passes (`npm run lint --workspaces`)

### Related Issues

{issue_references}

---

_Auto-generated by ADA dispatch cycle {N}_
```

---

## CLI Implementation (Sprint 2)

### New Flag: `ada dispatch complete --pr`

```bash
# For code changes
ada dispatch complete \
  --action "feat(cli): add terminal mode" \
  --pr

# For docs-only (no --pr, direct commit)
ada dispatch complete \
  --action "docs: update readme"
```

### Behavior with `--pr`:

1. **Create branch** from current HEAD
   - Name: `ada/c{cycle}-{role}-{slug}`
   - Slug derived from first 30 chars of action, slugified

2. **Commit changes** to branch
   - Message: conventional commit from action

3. **Open PR** via GitHub CLI

   ```bash
   gh pr create \
     --title "chore(agents): cycle {N} â€” {role} â€” {action}" \
     --body "{template}" \
     --base main
   ```

4. **Wait for CI** (configurable timeout, default 5min)

   ```bash
   gh pr checks {number} --watch
   ```

5. **Auto-merge** if CI passes

   ```bash
   gh pr merge {number} --squash --delete-branch
   ```

6. **Handle failures**
   - If CI fails: Log error, leave PR open for manual fix
   - If timeout: Log warning, leave PR for next cycle

### Edge Cases

| Scenario               | Behavior                                |
| ---------------------- | --------------------------------------- |
| No code changes staged | Skip PR, direct commit allowed          |
| Mixed code + docs      | Use PR (code takes precedence)          |
| CI flaky/slow          | 5min timeout, then leave PR open        |
| Merge conflicts        | Abort, log error, leave for human       |
| GitHub API failure     | Fall back to direct commit with warning |

---

## Configuration

Add to `ada.config.json`:

```json
{
  "dispatch": {
    "prWorkflow": {
      "enabled": true,
      "codePatterns": ["*.ts", "*.js", "*.json", "!agents/**/*.json"],
      "ciTimeout": 300,
      "autoMerge": true,
      "deleteBranch": true
    }
  }
}
```

---

## Migration Strategy

### Phase 1: Opt-In (Sprint 2 Week 1-2)

- Add `--pr` flag
- Default: direct commit (current behavior)
- Agents can opt-in per cycle

### Phase 2: Opt-Out (Sprint 2 Week 3-4)

- Change default to PR workflow for code changes
- Add `--no-pr` flag to bypass
- Update DISPATCH.md to require PR rationale if bypassing

### Phase 3: Mandatory (Sprint 3)

- Remove bypass options
- All code changes require PRs
- RULES.md updated with enforcement

---

## Rollback Plan

If PR workflow causes velocity issues or blockers:

1. Revert `prWorkflow.enabled` to `false` in config
2. Remove `--pr` requirement from DISPATCH.md
3. Document issues in retrospective
4. Iterate on design before re-enabling

---

## Success Criteria

| Metric                          | Target        | Measurement                         |
| ------------------------------- | ------------- | ----------------------------------- |
| Code changes via PR             | >90%          | Count PRs vs direct code commits    |
| CI failures caught before merge | 100%          | Zero post-merge CI failures on code |
| Dispatch cycle time             | <10% increase | Compare cycle durations             |
| Branch cleanup                  | 100%          | No stale ada/\* branches >24h       |

---

## Open Questions

1. **Self-review**: Should agents comment on their own PRs to satisfy review requirements?
2. **Multi-agent review**: Can a different role review and approve a PR in the next cycle?
3. **Emergency bypass**: What's the process for urgent fixes that can't wait for CI?

---

## References

- Issue #128: Original proposal
- R-010: PR Management & CI rules
- R-011: PR Hygiene & Transparency
- R-012: GitHub Templates

---

_This specification is approved for Sprint 2 implementation. Engineering to implement CLI changes, Ops to update DISPATCH.md and RULES.md._

# Test Coverage Audit ‚Äî Cycle 83

**Date:** 2026-02-06  
**Author:** üîç QA (The Inspector)  
**Cycle:** 83  
**Status:** Complete

---

## Executive Summary

Enabled test coverage tooling and conducted first comprehensive audit. Found mixed results:

- **Core:** 72.87% ‚Äî good foundation, specific gaps identified
- **CLI:** 1.04% measured (misleading due to subprocess testing)

221 tests pass. Test infrastructure is healthy. Coverage tooling now operational.

---

## Findings

### @ada/core ‚Äî 72.87% Coverage

| File               | Statements | Branch | Functions | Lines  | Notes         |
| ------------------ | ---------- | ------ | --------- | ------ | ------------- |
| embedding.ts       | 99.41%     | 85.91% | 100%      | 99.41% | ‚úÖ Excellent  |
| rotation.ts        | 80.95%     | 84%    | 57.14%    | 80.95% | ‚úÖ Good       |
| dispatch-memory.ts | 76.11%     | 93.33% | 82.35%    | 76.11% | ‚ö†Ô∏è OK         |
| memory.ts          | 57.53%     | 100%   | 62.5%     | 57.53% | ‚ö†Ô∏è Needs work |
| dispatch.ts        | 22.72%     | 100%   | 25%       | 22.72% | ‚ùå Low        |
| agent.ts           | 0%         | 100%   | 100%      | 0%     | ‚ùå Untested   |

**Key Gaps:**

- `agent.ts` (lines 9-194): Entire file untested ‚Äî likely dead code or needs integration
- `dispatch.ts` (lines 91-188): Core dispatch execution logic untested
- `memory.ts` (lines 17-41, 87-102): Bank parsing/writing gaps

**Threshold Status:** Below 80% threshold. CI would fail if enforced.

### @ada/cli ‚Äî 1.04% Coverage (Misleading)

Coverage measurement issue: **v8 coverage cannot track subprocess execution**.

CLI integration tests run commands via `execa` subprocess:

```typescript
await execa('ada', ['init'], { cwd: testDir });
```

This pattern is correct for E2E validation but v8 sees 0% coverage for those code paths.

**Real picture:**

- 89 tests exercise CLI functionality
- Commands work correctly (validated via subprocess)
- Measured coverage is artificially low

**Recommendation:** Don't enforce CLI coverage thresholds until NYC/istanbul subprocess coverage is implemented.

---

## Actions Taken This Cycle

1. ‚úÖ Installed `@vitest/coverage-v8@^3.2.0` (matched vitest version)
2. ‚úÖ Fixed empty describe block in `status.test.ts` causing suite failure
3. ‚úÖ Ran comprehensive coverage audit
4. ‚úÖ Documented findings

---

## Recommendations

### Immediate (P1)

1. **Create Issue: Core Coverage Gaps**
   - Target `agent.ts`, `dispatch.ts`, `memory.ts`
   - Goal: 80% core coverage before v1.0-alpha

2. **Do NOT enforce CLI coverage thresholds**
   - Current subprocess testing is valid approach
   - Would require NYC instrumentation to measure properly

### Future (P2)

3. **Issue #34: E2E Testing Infrastructure**
   - Consider in-process CLI testing for coverage
   - Alternatively, instrument with NYC for subprocess coverage

4. **Add coverage to CI** (optional)
   - Only for `@ada/core` with 80% threshold
   - CLI coverage is informational only

---

## Test Health Summary

| Metric        | Value     | Status                     |
| ------------- | --------- | -------------------------- |
| Total Tests   | 221       | ‚úÖ                         |
| Test Files    | 11        | ‚úÖ                         |
| Core Coverage | 72.87%    | ‚ö†Ô∏è Below 80%               |
| CLI Coverage  | 1.04%     | ‚ÑπÔ∏è (subprocess limitation) |
| Flaky Tests   | 0         | ‚úÖ                         |
| Empty Suites  | 0 (fixed) | ‚úÖ                         |

---

_Generated by QA cycle 83. Next audit recommended in 10 cycles._

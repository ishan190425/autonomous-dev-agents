# PR Workflow User Stories

> **Author:** ðŸ“¦ Product Lead (The PM)
> **Cycle:** C630
> **Issue:** #128 (PR Workflow for Agents)
> **Related:** R-014 (Agent PR Workflow), C624 (Rule), C625 (UX Spec)
> **Status:** Ready for Engineering

---

## Overview

This document formalizes user stories and acceptance criteria for the PR Workflow CLI integration (#128). These stories complement the UX Specification (C625) and provide Engineering with testable requirements.

---

## User Stories

### US-128-1: PR Mode Flag

**Priority:** P1  
**Size:** M  
**Effort:** 2-3 cycles

**Story:**

> As an agent making code changes, I want to use `ada dispatch complete --pr` so that my changes go through a Pull Request instead of a direct commit.

**Acceptance Criteria:**

- [ ] `--pr` flag added to `ada dispatch complete` command
- [ ] When `--pr` is used, creates a feature branch from current HEAD
- [ ] Branch follows naming convention: `ada/c{cycle}-{role}-{action-slug}`
- [ ] Commits changes to the feature branch (not main)
- [ ] Pushes feature branch to origin
- [ ] Creates a Pull Request via GitHub CLI (`gh pr create`)
- [ ] PR title follows conventional commit format from `--action`
- [ ] PR body includes action description, cycle number, role, and "Generated by `ada dispatch complete --pr`"
- [ ] Updates `rotation.json` with PR reference in history: `"action": "feat: ... â€” PR #N"`
- [ ] Exit code 0 on success, 1 on failure

**Testing Notes:**

- Unit test: Branch name generation with emoji handling, special chars, long strings
- Integration test: Full PR flow with mocked `gh` CLI
- E2E test: Create real PR in test environment

---

### US-128-2: Code Change Detection

**Priority:** P1  
**Size:** S  
**Effort:** 1-2 cycles

**Story:**

> As an agent, I want the CLI to detect when I have code changes and prompt me to use `--pr` so that I don't accidentally bypass the PR workflow.

**Acceptance Criteria:**

- [ ] CLI detects uncommitted changes to code files (`.ts`, `.js`, `.py`, etc.)
- [ ] When code changes exist AND `--pr` is not specified:
  - Display warning with list of modified files
  - Show suggestion: "Run with --pr to create a PR, or --force to commit directly"
  - Exit with code 1 (requires user decision)
- [ ] When `--force` is specified, proceed with direct commit (existing behavior)
- [ ] When only docs/agent state files changed, proceed without warning
- [ ] Change detection uses git status, not file scanning

**File Classification:**

| Pattern                  | Type        | PR Required |
| ------------------------ | ----------- | ----------- |
| `*.ts`, `*.js`, `*.py`   | Code        | âœ…          |
| `*.test.ts`, `*.spec.ts` | Test        | âœ…          |
| `*.json` (non-agent)     | Config      | âœ…          |
| `.github/workflows/*`    | CI          | âœ…          |
| `*.md`                   | Docs        | âŒ          |
| `agents/**`              | Agent state | âŒ          |

---

### US-128-3: Branch Name Generation

**Priority:** P1  
**Size:** S  
**Effort:** 1 cycle

**Story:**

> As an agent, I want branch names to be auto-generated from my action description so that branches are consistent and traceable to cycles.

**Acceptance Criteria:**

- [ ] Branch name format: `ada/c{cycle}-{role}-{action-slug}`
- [ ] Cycle number from current dispatch cycle
- [ ] Role ID lowercase: `ceo`, `growth`, `research`, `frontier`, `product`, `scrum`, `qa`, `engineering`, `ops`, `design`
- [ ] Action slug generated from action description:
  - Lowercase
  - Remove emoji and special characters
  - Replace spaces with hyphens
  - Truncate to 50 characters at word boundary
  - Remove trailing hyphens
- [ ] Function exported: `generateBranchName(cycle: number, role: string, action: string): string`

**Examples:**

| Action                                                               | Branch                                                       |
| -------------------------------------------------------------------- | ------------------------------------------------------------ |
| `"ðŸŽ¨ PR WORKFLOW CLI UX SPEC"`                                       | `ada/c630-design-pr-workflow-cli-ux-spec`                    |
| `"âš™ï¸ Heat Scoring CLI Integration"`                                  | `ada/c630-engineering-heat-scoring-cli-integration`          |
| `"Very long action description that exceeds fifty characters total"` | `ada/c630-product-very-long-action-description-that-exceeds` |

---

### US-128-4: Custom Branch Override

**Priority:** P2  
**Size:** S  
**Effort:** 1 cycle

**Story:**

> As an agent, I want to override the auto-generated branch name with `--branch` so that I can use custom naming when needed.

**Acceptance Criteria:**

- [ ] `--branch <name>` flag added to `ada dispatch complete`
- [ ] When provided, uses custom branch name instead of auto-generated
- [ ] Validation: Branch must start with valid prefix (`ada/`, `feat/`, `fix/`, `docs/`, `refactor/`, `ci/`)
- [ ] Validation: Only lowercase letters, numbers, hyphens, slashes
- [ ] Validation: Max 100 characters
- [ ] Error on invalid: Display validation rules and example

---

### US-128-5: Draft PR Support

**Priority:** P2  
**Size:** S  
**Effort:** 1 cycle

**Story:**

> As an agent, I want to create draft PRs with `--draft` so that I can share work-in-progress for visibility without marking it ready for review.

**Acceptance Criteria:**

- [ ] `--draft` flag added to `ada dispatch complete`
- [ ] When used with `--pr`, creates PR as draft
- [ ] Output shows `[DRAFT]` indicator: `PR #44 â€” feat: ... [DRAFT]`
- [ ] Tip shows: "Mark ready with `gh pr ready 44`"
- [ ] Rotation history includes draft indicator: `"action": "feat: ... â€” Draft PR #N"`

---

### US-128-6: CI Status Display

**Priority:** P2  
**Size:** S  
**Effort:** 1 cycle

**Story:**

> As an agent, I want to see CI status after creating a PR so that I know if checks are pending or failing.

**Acceptance Criteria:**

- [ ] After PR creation, display CI status table
- [ ] Show status for each check: `â³ pending`, `âœ… passing`, `âŒ failing`
- [ ] Tip shows: "Run `gh pr checks {number} --watch` to monitor"
- [ ] Non-blocking: Display available info, continue if status unavailable

---

### US-128-7: JSON Output

**Priority:** P3  
**Size:** S  
**Effort:** 1 cycle

**Story:**

> As a script or automation tool, I want JSON output with `--json` when using `--pr` so that I can programmatically process PR creation results.

**Acceptance Criteria:**

- [ ] `--json` flag works with `--pr` mode
- [ ] Output includes: `success`, `cycle`, `role`, `action`, `pr.number`, `pr.url`, `pr.branch`, `pr.state`, `pr.draft`, `commit.sha`, `commit.message`, `nextRole`
- [ ] On error, includes `error` field with message

---

## Implementation Phases

### Phase 1: Core PR Flow (Sprint 2)

| Story    | Priority | Dependency |
| -------- | -------- | ---------- |
| US-128-1 | P1       | None       |
| US-128-2 | P1       | US-128-1   |
| US-128-3 | P1       | US-128-1   |

**Exit Criteria:**

- `ada dispatch complete --pr` creates valid PRs
- Code changes without `--pr` trigger warning
- Branch names follow convention

### Phase 2: Enhanced Features (Sprint 2-3)

| Story    | Priority | Dependency |
| -------- | -------- | ---------- |
| US-128-4 | P2       | US-128-1   |
| US-128-5 | P2       | US-128-1   |
| US-128-6 | P2       | US-128-1   |
| US-128-7 | P3       | US-128-1   |

### Phase 3: Enforcement (Future)

- CI check to reject direct code pushes to main
- Auto-merge option for agents

---

## Dependency Graph

```
US-128-1 (Core PR Flow)
    â”‚
    â”œâ”€â”€ US-128-2 (Code Detection)
    â”‚
    â”œâ”€â”€ US-128-3 (Branch Generation)
    â”‚
    â””â”€â”€ US-128-4 to US-128-7 (Enhancements)
```

US-128-1 is the critical path â€” all other stories depend on it.

---

## Success Metrics

| Metric                 | Target            |
| ---------------------- | ----------------- |
| Code changes via PR    | 100% post-Phase 1 |
| Direct code commits    | 0 after Phase 3   |
| PR creation errors     | <5% of attempts   |
| Branch name collisions | 0                 |

---

## References

- **R-014:** Agent PR Workflow rule
- **C624:** Rule addition (Ops)
- **C625:** UX Specification (Design)
- **Issue #128:** Tracking issue
- **QA Analysis (C332):** Quality gate requirements

---

_ðŸ“¦ The PM â€” Cycle 630_
